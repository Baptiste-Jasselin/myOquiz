# S05E05 - Sequelize

## Menu du jour 

```
- Correction challenge
  - Tous les mod√®les Sequelize

- Associations Sequelize
  - Mise en place
  - Quelques tests

- Oquiz is alive !
  - √ânonc√© **atelier PP**
  - Pas de challenge üéâ

- R√©visions (facultatifs)
  - Pages d'administration des levels
  - Ocode (pr√©paration du parkour solo) :
    - Lutins (Sequelize, mise en place des models et associations)
    - Requ√™tes complexes (jointures)
```


## Import export 

```js
// associations.js

module.exports = { Quiz, Question };
```

```js
// main.js

const { Quiz, Question } = require("./associations");
```

----

```js
// Vehicule.js

module.exports = Vehicule;
```

```js
// main.js

const Vehicule = require("./Vehicule");
```

## Alias d'une association

```js
Question.belongsTo(Level, {
  foreignKey: "level_id", // OBLIGATOIRE : pr√©ciser le nom de la cl√© √©trang√®re
  as: "level" // FACULTATIF : Pr√©ciser l'alias de l'association, pour faciliter la query
});

Level.hasMany(Question, {
  foreignKey: "level_id",
  as: "questions"
});
```

L'alias permet de faire l'appel de cette mani√®re : 

```js
// Sans alias 
const { Question, Level } = require("...")
Question.findOne({ include: Level }); // => ici, on est oblig√© d'importer Level

// Avec alias 
const { Question } = require("...")
Question.findOne({ include: "level" }); // => ici, pas besoin d'importer Level, on se sert de l'alias
```

Ca change aussi le nom de l'atribut renvoy√© : 

```js

// Sans alias 
const question = await Question.findOne({ include: Level }); 
// question = { id, description, wiki, anecdote, Level: { ... } }

// Avec l'alias
const question = await Question.findOne({ include: "level" }); 
// question = { id, description, wiki, anecdote, level: { ... } }
```


```js
// Sans alias 
const level = await Level.findOne({ include: Quiz }); 
// question = { id, name, Quiz: [{}, {}, {}] }
//                        ^ probl√®me, le nom du champs n'indique pas que c'est un array !

// Avec l'alias
const level = await Level.findOne({ include: "quizzes" }); 
// question = { id, name, quizzes: [{}, {}, {}] }
//                        ^ on est content, c'est bien nomm√© !
```

## `toJSON()` vs `get()` vs `JSON.stringify()`

Rappel : c'est uniquement pour TESTER, pour am√©liorer l'affichage du `console.log` et s'y retrouver plus facilement

Si on a un OBJET, on peux utiliser : 
- `.get(question)`
- `.toJSON(question)` : 
  - ici, on stringify aussi les champs "included"
  - √† privil√©gier donc !

Si on a un TABLEAU d'OBJETS, on peut utiliser : 
- `JSON.stringify(questions)`


Par exemple : 

```js
const users = await User.findAll(); // [{}, {}]
console.log(users); // [{ ... bcp de chose du Model Sequelize ... }]
console.log(JSON.stringify(users)); // [{....}, {....}, {....}]
console.log(JSON.stringify(users, null, 2)); // pour sauter des lignes entre les attributs
```

```js
const user = await User.findByPk(1); // {}
console.log(user); // { ... bcp de chose du Model Sequelize ... }
console.log(user.get()); // { id, firstname, lastname, email, password }
console.log(user.toJSON()); // { id, firstname, lastname, email, password }
```

## `Pull Request`

Quand on d√©veloppe sur une branche, avant de merger son code sur la branche principale, on aime bien : 
- se relire
- faire relire son code √† d'autres devs du projet 
  - pour progresser
  - pour homog√©n√©iser le code
  - pour attraper quelques bugs avant qu'ils arrivent sur la branche principale 

Pour cela, on `push` la branche sur Github et on cr√©er une Pull Request : 
- `PR` = `Pull Request` = demande d'int√©gration du code d'une branche dans une autre

D√©marche : 
- Push la branche
- Cr√©er la PR sur Github
- Faire valider la PR (optionel si on est seul)
- Button "Merge"
  - le code de `main` sur Github est √† jour !
- Puis en local, mettre √† jour notre `main` (local) avec le `main` du remote (Github)
  - `git pull`


## A faire

- Quelques exercices / questions bonus
- Recap' saison
- Enonc√© de l'atelier PP
- DEUX OPTIONS (apr√®s 14h) : 
  - autonomie sur l'exo des pages des Levels
  - correction guid√©e des pages des Levels (avec replay !)

## Bilan de saison 

- Gestion de projet : 
  - Clarification du besoin
  - Kanban
  - Wireframe
  - User-stories

- Architecture : 
  - Variables d'environnement
  - Router
  - Controlleurs
  - `.gitignore`
  - `ESLint`
  - `public`
  - MVC : 
    - Mod√®le (Sequelize)
    - View (EJS)
    - Controller (Express)

- Mod√©lisation : 
  - MCD (conceptuel -> pour Mamie) : qu'est-ce qu'on stock
  - MLD (logique -> pour les techos) : comment on le stock
  - MPD (physique -> pour le SGBD) : stockons le (avec les types)

- POO : 
  - Fabrique (`class`)
  - Instance (`new`) (un "representant" de la classe)
  - Constructor (`constructor`) pour cr√©er des instances
  - Propri√©t√©s / Attributs 
    - priv√©es (`#`)
    - publiques
  - Getters :
    - concept (`getFullName()`)
    - sucre JS (`get firstname()`)
  - Setters : 
    - concept (`set("name", "Harry")` / `setName("Harry")`)
    - sucre JS (`set firstname(value)`)
  - H√©ritage : 
    - `extends`
    - principe : cr√©er une "sous-classe" qui h√©rite des propri√©t√©s ET des m√©thodes de la classe parente
    - `super()` appeler le constructor de la classe parente

- Active Record : 
  - `class Tag {}` 
  - repr√©sente la structure de nos tables
  - les instances de la classe repr√©sente les **enregistrements** dans la table
  - la classe embarque des m√©thodes pour acc√©der directement √† la BDD
  - dans notre cas, remplacer le `dataMapper`

- Sequelize (ORM) : 
  - Installation
  - Cr√©ation du client `sequelize-client` pour se connecter √† notre BDD
  - Mise en place des mod√®les (`extends Model`)
  - Mise en place des associations
  - On a test√© => mais en pratique, on attaque les controlleurs !

- Git / Github : 
  - cr√©er une branche
  - merger une branche dans une autre
  - commit r√©guli√®rement
  - cr√©er une PR pour √™tre relu
  - changer de branche


## Recap `Sequelize` pour les queries

```js
Quiz.findAll({
  attributes: ["description"],      // SELECT props => selectionner uniquement quelques champs
  limit: 3,                         // LIMIT 3      => restreindre le nombre d'enregistrements renvoy√©s
  order: [["title", "ASC"]],        // ORDER BY     => trier 
  where: { ... },                   // WHERE ...    => filtrer 
  include: ...                      // JOIN         => joindre des donn√©es d'autres tables
});
```

```js
// Ces queries sont √©quivalentes

Quiz.findOne({
  include: "questions"
});

Quiz.findOne({
  include: { association: "questions" } // On peut ajouter quelques options compl√©mentaires sur la table li√©e 
});

Quiz.findOne({
  include: ["questions"] // On peut inclure plusieurs tables !
});

Quiz.findOne({
  include: [{ association: "questions" }] // On peut inclure plusieurs tables et customiser les options
});
```

```js
// Deep include
Quiz.findOne({
  include: {
    association: "questions",
    include: "propositions"
  }
})
```

