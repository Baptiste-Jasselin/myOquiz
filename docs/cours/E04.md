# S05E04 - Active Record, ORM & Sequelize

## Menu du jour 

```
- Correction challenge
  - Model `User` version Active Record
  - Début d'une factorisation dans le `CoreModel` (bonus)
  - Un peu de `git` (bonus) ?
 
- ORM `Sequelize`
  - Documentation
  - Installation
  - Mise en place des Models
  - Utilisation des Models (tests)
```


## Git - Github

- `git checkout -b <nom_de_branche>` : créer une branche, ie. version du logiciel (et de se placer sur cette branche)
- `git checkout <nom_de_branche>` : se placer sur la branche existante 
- `git branch --show-current` : vérifier sur quelle branche on est placé 
- `git push --set-upstream origin <nom_de_branche>` : pour push sur une branche 
  - (la première fois seulement, ensuite `git push` fonctionnera bien)

En pratique, pourquoi on créé des branches ? 
- parce qu'on est plusieurs à bosser sur le projet : 
  - si on code tous sur `main`, on va se marcher sur les pieds !


### Récupérer la branche quand vous cloner ?

- Si tu clones MAINTENANT, tu la récupères bien. Mais il faut te PLACER dessus via un `git checkout active-record` (sinon, on est sur `main` par défaut)

Si tu l'as cloné HIER, tu peux la récupérer via une autre démarche : 
- `git pull`
- `git checkout active-record`


## Convention pour les commits

[Conventional commits](https://www.conventionalcommits.org/en/v1.0.0/)

- `feat` : ajout d'une fonctionnalité (feature)
- `fix` : correction d'un bug
- `docs` : écriture de documentation, commentaires, ...
- `refactor` : modification (amélioration) du code sans changer la feature sous jacente
- `test` : ajout de tests
- `chore` : configuration du projet

Préfixes qu'on ajoute en tête de commit pour préciser ce qu'il fait.

## Merger

- Retourner sur la branche principale (ex : `git checkout main` / `git checkout master`)
- Merger une sous branche : `git merge active-record`
- Mettre à jour le dépôt Github : `git push`

Note : la branche `active-record` existe toujours. On peut la supprimer manuellement, ou la laisser vivre car elle ne gène. Pour la supprimer : `git branch -D active-record`


## ORM 

`ORM` = `Object Relational Mapping`

- Object : `{}`
- Relational : `Table`
- Mapping : lien

=> On fait le lien entre des objets (JS) et nos tables

C'est une façon d'accèder à notre BDD depuis notre code applicatif. 

### Exemples d'ORM

- `Sequelize`
- `TypeORM`
- `Prisma`
- `Mongoose`

### Sequelize

Pourquoi ? Car il est basé sur `Active Record` et qu'on a étudié ce design pattern ! 

La documentation est ici : https://sequelize.org/

### COmment s'y prendre 

- Installer `Sequelize` : 
  - `npm install sequelize pg`

- Définir nos modèles : 
  - par exemple, dans le dossier `/models`
  - `extends Model` de Sequelize
  - définir les propriétés de nos entités (name, firstname, wiki, anecdote, email, ...)

- Utiliser les méthodes d'accès fournis "automatiquement" par les modèles Sequelize : 
  - `findAll()`, `findByPk()`, `save()`, `create()`, `delete()`, ....



## Types

### En Postgres

[Documentation complète](https://www.postgresql.org/docs/current/datatype.html)

```js
// Types "chaine de caractères" en Postgres

TEXT // nombre de caractère illimité
VARCHAR(N) // entre 0 et N caractères
CHAR(N) // exactement N caractères

```

### En Sequelize

[Documentation complète](https://sequelize.org/docs/v7/models/data-types/)


```js
// Types "chaine de caractères" en Postgres

TEXT // nombre de caractère illimité   --> equivalent de Postgres : TEXT
STRING(N) // entre 0 et N caractères   --> equivalent de Postgres : VARCHAR   (pourquoi ? => on en sait rien :D !)
CHAR(N) // exactement N caractères     --> equivalent de Postgres : CHAR

```


## Redondance entre `Script SQL` et `Modèle Sequelize`

On définie nos données 1 fois dans le script `create_tables.sql`

On redéfinie nos données 1 fois dans le nos modèles Sequelize 

=> On se répète...
=> On risque d'avoir des incohérences parfois...

=> Solution : il est possible de CREER les tables en passant par les modèles Sequelize => fini le script `.sql`

=> Note : on ne va PAS le faire chez Oclock (je vous montrerais, car c'est là aussi l'intérêt d'utiliser un ORM)

